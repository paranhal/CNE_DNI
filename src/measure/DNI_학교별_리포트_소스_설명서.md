# 대전(DNI) 학교별 문제점분석 리포트 시스템 - 소스코드 상세 설명서

> 프로그래밍을 처음 접하는 분도 이해할 수 있도록 작성한 문서입니다.

---

## 1. 전체 구조 요약

이 시스템은 **3개의 파이썬(.py) 파일**로 구성되어 있습니다.

| 파일명 | 역할 | 비유 |
|--------|------|------|
| `dni_school_report_config.py` | 설정 파일 | 요리의 "레시피" (재료·분량 정의) |
| `dni_school_report_generator.py` | 리포트 생성기 | 요리하는 "셰프" (실제 실행) |
| `dni_school_report_merge.py` | 통합 파일 생성기 | 완성된 요리를 "한 접시에 담는" 역할 |

### 실행 순서

```
1단계: dni_school_report_generator.py 실행
       → 학교별 개별 리포트 315개 생성 (학교명_학교코드.xlsx)
       → 지역별 폴더(대덕구, 동구, 서구, 유성구, 중구)로 복사

2단계: dni_school_report_merge.py 실행
       → 315개 파일을 읽어서 하나의 통합 Excel 파일로 합침
```

### 입력/출력 파일

```
[입력]
  ├── 최종_측정값_템플릿.xlsx          ← 빈 양식 (리포트 틀)
  ├── DNI/DNI_TOTAL_MEASURE_LIST_V1.xlsx  ← 전체 측정 데이터 (통계)
  └── school_reg_list_DNI.xlsx         ← 대전 학교 목록

[출력]
  ├── DNI/학교별_리포트/
  │   ├── 대전경덕중학교_G107441266MS.xlsx   ← 학교별 개별 파일
  │   ├── 대전대양초등학교_G107441056ES.xlsx
  │   ├── ...총 315개...
  │   ├── 대덕구(41)/   ← 지역별 폴더 (파일 복사본)
  │   ├── 동구(46)/
  │   ├── 서구(90)/
  │   ├── 유성구(83)/
  │   └── 중구(55)/
  └── DNI/DNI_학교별_문제점분석_통합.xlsx   ← 전체 통합 파일
```

---

## 2. 설정 파일: `dni_school_report_config.py` (112줄)

이 파일은 **"무엇을 어디서 읽어서 어디에 쓸지"를 정의**합니다.
프로그램이 실행될 때 이 파일의 설정값을 읽어서 사용합니다.

### 2-1. 경로 설정 (14~27행)

```python
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DNI_DIR = os.path.join(BASE_DIR, "DNI")
OUTPUT_DIR = os.path.join(DNI_DIR, "학교별_리포트")
```

- `BASE_DIR`: 이 파일이 위치한 폴더 경로 (예: `D:\CNE_DNI\src\measure`)
- `DNI_DIR`: 대전 데이터 폴더 (`D:\CNE_DNI\src\measure\DNI`)
- `OUTPUT_DIR`: 결과물이 저장될 폴더 (`DNI/학교별_리포트`)

### 2-2. 템플릿 파일 후보 (18~25행)

```python
TEMPLATE_CANDIDATES = [
    os.path.join(BASE_DIR, "최종_측정값_템플릿.xlsx"),
    os.path.join(TEMPLATE_DIR, "최종_측정값_템플릿.xlsx"),
    ...
]
```

프로그램은 이 목록을 위에서부터 순서대로 확인하며, **처음 발견된 파일**을 템플릿으로 사용합니다.
여러 이름을 넣어둔 이유는 파일명이 조금 달라도 자동으로 찾을 수 있게 하기 위함입니다.

### 2-3. 측정값 매핑: J_OUTPUT_MAP (30~58행) ★ 핵심

이 부분이 **가장 중요한 설정**입니다. "통계 파일의 어떤 시트, 어떤 열의 값을 → 리포트의 몇 번째 행에 넣을지"를 정의합니다.

```python
J_OUTPUT_MAP = [
    (2, "학교별통신장비현황", 16, None, None),
    # ↑행  ↑시트이름         ↑열   ↑열2  ↑포맷
]
```

각 항목은 **5개의 값**으로 구성됩니다:

| 위치 | 의미 | 예시 |
|------|------|------|
| 1번째 | 리포트의 **행 번호** | `2` → 리포트 2행에 값 입력 |
| 2번째 | 통계 파일의 **시트 이름** | `"학교별통신장비현황"` |
| 3번째 | 읽을 **열 번호** (또는 열 목록) | `16` → P열 |
| 4번째 | 두 번째 열 번호 (없으면 None) | `None` |
| 5번째 | **출력 형식** | `None`=단순, `"cable"`=케이블, `"fullload"`=전부하 등 |

**실제 예시 해석:**

```python
(21, "전부하측정_학교별평균", 3, 4, "fullload")
```
→ "전부하측정_학교별평균" 시트에서 C열(3)과 D열(4)을 읽어서,
   리포트 21행에 `375.2(Mbps)\n420.1(Mbps)` 형태로 입력

```python
(6, "케이블통계", [4, 5, 6, 7, 8], None, "cable")
```
→ "케이블통계" 시트에서 D,E,F,G,H열을 한꺼번에 읽어서,
   리포트 6행에 `SM(264)\nMM(415)\nCAT6(3003)\nCAT5e(921)\nCAT5(765)` 형태로 입력

**특수 시트 이름:**
- `"fixed"`: 고정값을 그대로 입력 (예: `"80 Mhz"`)
- `"h_only"`: 측정값은 입력하지 않고 판정(H열)만 처리

### 2-4. 판정 기준: L_JUDGMENT_MAP (60~88행)

각 항목의 **"정상" vs "개선필요" 판정 기준**을 정의합니다.

```python
L_JUDGMENT_MAP = [
    (2, "le", 0),
    # ↑행  ↑연산  ↑기준값
]
```

| 연산 | 의미 | 예시 |
|------|------|------|
| `"le"` | 기준값 **이하**이면 정상 | `(2, "le", 0)` → 0 이하면 정상 |
| `"ge"` | 기준값 **이상**이면 정상 | `(23, "ge", 375)` → 375 이상이면 정상 |
| `"always"` | **항상** 정상 | `(3, "always", "정상")` |
| `"has_value"` | 값이 **있으면** 개선필요 | `(15, "has_value", None)` |
| `"split_exact"` | "분리"면 정상, "미분리"면 개선필요 | `(20, "split_exact", 0)` |
| `"both_ge"` | 두 값 **모두** 기준 이상이어야 정상 | `(21, "both_ge", 375)` |
| `"zero_or_empty_ok"` | 값이 없거나 0이면 정상 | `(10, "zero_or_empty_ok", 0)` |
| `"ge_before_keyword"` | "계위" 앞 숫자가 기준 이상이면 개선필요 | `(18, "ge_before_keyword", 3)` |

### 2-5. 기타 설정 (90~111행)

```python
J_COL = 6    # F열 = 측정값을 입력하는 열
L_COL = 8    # H열 = 판정결과를 입력하는 열
G_COL = 7    # G열 = 기준값 표시 열

ROUND_1_ROWS = {14, 26, 27}   # 소수점 1자리로 반올림할 행
FONT_BLACK_ROWS = (28, 29, 30) # 글자색을 검정으로 지정할 행

SCHOOL_LIST_FILES = [           # 학교 목록 파일명 후보
    "school_reg_list_DNI.xlsx",
    "school_reg_list_DNI.csv",
]
```

---

## 3. 리포트 생성기: `dni_school_report_generator.py` (448줄)

이 파일이 **실제로 학교별 리포트를 만드는 메인 프로그램**입니다.

### 3-1. 프로그램 시작 준비 (1~49행)

```python
from openpyxl import load_workbook    # Excel 파일을 읽고 쓰는 도구
from openpyxl.styles import Font      # 글자 색상 등 스타일 도구
from tqdm import tqdm                 # 진행률 표시 (프로그래스 바)
```

- `openpyxl`: 파이썬에서 Excel(.xlsx) 파일을 다루는 라이브러리
- `tqdm`: `학교별 생성: 45%|████▌ | 285/633` 같은 진행률 바를 보여주는 도구

그 아래에서 config 파일의 설정값들을 가져옵니다(import).

### 3-2. 보조 함수들

#### `sanitize_filename(s)` (52~58행) - 파일명 정리

```python
def sanitize_filename(s):
    # 파일명에 사용할 수 없는 문자( \ / : * ? " < > | )를 _로 바꿈
    # 예: "대전/경덕중" → "대전_경덕중"
```

Windows에서 파일명에 `/`나 `*` 같은 문자를 쓸 수 없기 때문에,
학교명에 이런 문자가 있으면 `_`(밑줄)로 바꿔줍니다.

#### `find_template()` (61~70행) - 템플릿 찾기

config에 정의된 후보 경로를 하나씩 확인하며 실제 존재하는 파일을 찾습니다.
못 찾으면 `None`을 반환하고 프로그램이 종료됩니다.

#### `load_full_school_list()` (73~123행) - 학교 목록 로드

`school_reg_list_DNI.xlsx` (또는 .csv) 파일에서 **학교코드 → 학교명** 매핑을 읽어옵니다.

```
예시:
  G107441266MS → 대전경덕중학교
  G107441056ES → 대전대양초등학교
```

이 정보는 나중에 파일 이름을 만들 때 사용됩니다.

#### `load_stats_by_school(wb_stats)` (126~143행) - 통계 데이터 인덱싱

통계 파일(`DNI_TOTAL_MEASURE_LIST_V1.xlsx`)의 **모든 시트**를 순회하면서,
각 학교코드가 몇 번째 행에 있는지 기록합니다.

```
결과 예시:
  by_school = {
      "G107441266MS": {
          "학교별통신장비현황": 5,    ← 이 시트의 5행에 데이터 있음
          "POE": 2,                  ← 이 시트의 2행에 데이터 있음
          "ISP측정_학교별평균": 3,
          ...
      },
      "G107441056ES": { ... },
  }
```

나중에 특정 학교의 데이터를 빠르게 찾기 위한 **색인(인덱스)** 역할입니다.

#### `get_school_values(...)` (146~164행) - 한 학교의 한 항목 값 읽기

config의 `J_OUTPUT_MAP`에 정의된 대로, 특정 시트의 특정 열에서 값을 읽어옵니다.

```
예: row_def = (21, "전부하측정_학교별평균", 3, 4, "fullload")

→ "전부하측정_학교별평균" 시트에서
   해당 학교의 행(data_row)의 C열(3), D열(4) 값을 반환
```

#### `get_numeric(val)` (167~178행) - 숫자 변환

Excel 셀의 값을 숫자(float)로 변환합니다.
`"375.2"` 같은 문자열도 `375.2`로, 쉼표가 있는 `"1,234"`도 `1234.0`으로 변환합니다.
숫자가 아니면 `None`을 반환합니다.

#### `judge(val, op, threshold, val2)` (181~225행) - 판정 함수 ★

측정값을 기준에 따라 **"정상" 또는 "개선필요"로 판정**하는 핵심 함수입니다.

```
예시 1: judge(375.2, "ge", 375)
        → 375.2 >= 375 이므로 → "정상"

예시 2: judge(3.5, "le", 3)
        → 3.5 <= 3 이 아니므로 → "개선필요"

예시 3: judge("분리", "split_exact", 0)
        → "분리"이므로 → "정상"
```

#### `format_value(v)` (228~233행) - 값 정리

None이나 빈 문자열은 `""`로, 숫자는 그대로, 문자열은 앞뒤 공백을 제거합니다.

#### `format_output_value(v1, v2, row_def)` (236~279행) - 출력 형식 변환

config의 `format_type`에 따라 값을 적절한 형태로 변환합니다:

| format_type | 변환 결과 예시 |
|------------|---------------|
| `None` (단순) | `375.2` 또는 `375.2 / 420.1` |
| `"cable"` | `SM(264)\nMM(415)\nCAT6(3003)\nCAT5e(921)\nCAT5(765)` |
| `"fullload"` | `375.2(Mbps)\n420.1(Mbps)` |
| `"location5"` | `위치 5 - 3\n위치 5 외 - 20\n보관 및 확인불가 - 없음` |
| `"n_ac_ax"` | `N - 0식\nAC - 23식\nAX - 0식` |
| `"fixed"` | `80 Mhz` (고정값 그대로) |

(`\n`은 Excel 셀 안에서의 줄바꿈입니다)

### 3-3. 리포트 생성 함수: `generate_school_report(...)` (282~324행) ★★

**한 학교의 리포트를 만드는 핵심 함수**입니다. 과정은 다음과 같습니다:

```
① 템플릿 파일을 메모리에 복사 (load_workbook)
② "문제점분석" 시트를 선택
③ J_OUTPUT_MAP의 각 항목에 대해 반복:
   ├─ 통계 파일에서 해당 학교의 측정값을 읽음
   ├─ 값을 적절한 형식으로 변환
   ├─ F열(6열)에 측정값 입력
   │   └─ 특정 행(14, 26, 27)은 소수점 1자리로 반올림
   └─ H열(8열)에 판정결과("정상"/"개선필요") 입력
       └─ "개선필요"이면 빨간 글씨로 표시
④ 21행 G열에 "375 Mhz 이상" 고정값 입력
⑤ H열의 정상/개선필요 개수를 세서 36~37행에 기록
⑥ 완성된 워크북 반환
```

### 3-4. 메인 실행 함수: `main()` (327~385행)

프로그램을 실행하면 호출되는 함수입니다. 전체 흐름:

```
① 템플릿 파일 찾기 (없으면 종료)
② 통계 파일 확인 (없으면 종료)
③ 학교 목록 로드 (school_reg_list_DNI.xlsx)
④ 통계 파일 열기 → 학교별 데이터 위치 인덱싱
⑤ 데이터가 없는 학교 목록을 로그 파일에 기록
⑥ 학교별 반복 (315개):
   ├─ generate_school_report() 호출 → 리포트 생성
   └─ 학교명_학교코드.xlsx 로 저장
⑦ 통계 파일 닫기
⑧ 지역별 폴더 복사 (copy_reports_by_region)
```

### 3-5. 지역별 폴더 복사 (388~444행)

```
① 통계 파일의 Sheet1에서 학교코드 → 지역(구) 매핑을 읽음
   예: G107441266MS → 대덕구
② 기존 지역 폴더가 있으면 삭제 (재실행 시 중복 방지)
③ 각 리포트 파일의 학교코드로 지역을 확인
④ 지역별 폴더를 만들고 파일 복사
   폴더명 형식: "대덕구(41)", "서구(90)" 등
```

---

## 4. 통합 파일 생성기: `dni_school_report_merge.py` (222줄)

생성된 315개 학교별 리포트를 **하나의 Excel 파일로 합치는** 프로그램입니다.
각 학교의 세로형 데이터를 **가로형(한 행에 한 학교)**으로 변환합니다.

### 4-1. 항목 이름 정의: ITEM_NAMES (33~67행)

리포트의 각 행 번호에 해당하는 항목 이름입니다.

```python
ITEM_NAMES = {
    2: "100M급 장비 수",
    4: "PoE 사용포트 수",
    21: "전부하 평균속도",
    23: "무선 다운로드",
    32: "Jitter",
    ...  # 총 33개 항목
}
```

### 4-2. 데이터 추출: `extract_school_data(filepath)` (87~97행)

학교 리포트 파일 1개를 열어서 F열(측정값)과 H열(판정결과)의 2~34행 데이터를 읽습니다.

### 4-3. 헤더 구성: `build_headers()` (100~109행)

통합 파일의 열 제목을 만듭니다:

```
학교코드 | 학교명 | 지역 | 100M급 장비 수_측정값 | 100M급 장비 수_판정 | ... | 정상_수 | 개선필요_수
```

각 항목마다 `_측정값`과 `_판정` 2개씩, 총 **71개 열**이 됩니다:
- 기본 3개 (학교코드, 학교명, 지역)
- 항목 66개 (33개 항목 × 2)
- 요약 2개 (정상_수, 개선필요_수)

### 4-4. 메인 실행: `main()` (112~222행)

```
① 학교별_리포트 폴더에서 xlsx 파일 목록 수집 (315개)
② 지역 매핑 로드 (Sheet1에서)
③ 각 파일을 순서대로 열어서 데이터 추출:
   ├─ 파일명에서 학교코드 추출 (예: "대전경덕중학교_G107441266MS.xlsx")
   ├─ F열(측정값) 33개 + H열(판정) 33개 읽기
   └─ 정상/개선필요 개수 카운트
④ 새 Excel 파일 생성:
   ├─ 시트명: "문제점분석_통합"
   ├─ 헤더: 파란 배경 + 흰색 굵은 글씨
   ├─ 데이터: 테두리 + "개선필요"는 빨간 글씨
   ├─ 필터 적용 (헤더 드롭다운)
   └─ D2 기준 행/열 고정 (스크롤해도 학교 정보가 보임)
⑤ DNI_학교별_문제점분석_통합.xlsx 로 저장
```

---

## 5. 실행 방법

### 사전 준비

1. Python 3.x 설치 필요
2. 필요한 라이브러리 설치:
   ```
   pip install openpyxl tqdm
   ```

### 실행 명령

**명령 프롬프트(cmd) 또는 PowerShell**에서:

```bash
# 1단계: 학교별 리포트 생성 (315개 파일 + 지역별 폴더)
cd D:\CNE_DNI\src\measure
python dni_school_report_generator.py

# 2단계: 통합 파일 생성
python dni_school_report_merge.py
```

### 실행 결과 예시

```
==================================================
[대전(DNI) 학교별 측정 리포트] 생성 (템플릿 사용)
==================================================
템플릿: D:\CNE_DNI\src\measure\최종_측정값_템플릿.xlsx
통계: D:\CNE_DNI\src\measure\DNI\DNI_TOTAL_MEASURE_LIST_V1.xlsx
출력: D:\CNE_DNI\src\measure\DNI\학교별_리포트
학교별 생성: 100%|██████████| 633/633 [00:32<00:00, 19.54교/s]
[완료] 633개 학교 리포트 생성

[지역별 폴더 복사] 시작
[완료] 315개 파일 → 5개 지역 폴더 복사
  대덕구(41)
  동구(46)
  서구(90)
  유성구(83)
  중구(55)
```

---

## 6. 자주 묻는 질문 (FAQ)

### Q1. 판정 기준을 바꾸고 싶으면?

`dni_school_report_config.py`의 `L_JUDGMENT_MAP`을 수정합니다.
예를 들어 Jitter 기준을 5ms → 10ms로 바꾸려면:

```python
# 변경 전
(32, "le", 5),     # 5 이하면 정상
# 변경 후
(32, "le", 10),    # 10 이하면 정상
```

### Q2. 새로운 측정 항목을 추가하려면?

`J_OUTPUT_MAP`에 새 항목을 추가하고, 필요하면 `L_JUDGMENT_MAP`에도 판정 기준을 추가합니다.

### Q3. 다른 지역(예: 세종)에 적용하려면?

1. `dni_school_report_config.py`를 복사해서 새 config 파일 생성
2. 경로(`DNI_DIR`), 시트 이름(`"대전AP"` → 해당 지역 AP 시트), 학교 리스트 파일명 변경
3. generator 파일도 복사 후 config import 경로만 변경

### Q4. "개선필요"가 빨간색으로 안 나오면?

Excel에서 파일을 열 때 "매크로 사용" 또는 "편집 사용"을 눌러야 서식이 보일 수 있습니다.

### Q5. 파일 저장 시 "PermissionError" 오류가 나면?

해당 Excel 파일이 이미 열려 있는 상태입니다. Excel에서 파일을 닫고 다시 실행하세요.
프로그램은 자동으로 `_백업` 이름으로 저장을 시도합니다.

---

## 7. 용어 정리

| 용어 | 설명 |
|------|------|
| `openpyxl` | 파이썬에서 Excel 파일(.xlsx)을 읽고 쓰는 라이브러리 |
| `load_workbook()` | Excel 파일을 메모리에 불러오는 함수 |
| `ws.cell(행, 열).value` | Excel 시트의 특정 셀 값을 읽거나 쓰는 방법 |
| `tqdm` | for 반복문의 진행률을 화면에 보여주는 라이브러리 |
| `os.path.join()` | 폴더 경로를 안전하게 연결하는 함수 (예: `"DNI" + "학교별_리포트"`) |
| `shutil.copy2()` | 파일을 복사하는 함수 (수정 날짜 등 메타데이터도 유지) |
| `dict` (딕셔너리) | `{키: 값}` 형태로 데이터를 저장하는 구조 (예: `{"G1074...": "대전경덕중학교"}`) |
| `list` (리스트) | `[값1, 값2, ...]` 형태로 여러 값을 순서대로 저장하는 구조 |
| `함수 (function)` | 특정 작업을 묶어서 이름을 붙인 코드 블록. `def 이름():` 형태로 정의 |
| `import` | 다른 파일이나 라이브러리의 기능을 가져와서 사용하겠다는 선언 |

---

*이 문서는 2026년 2월 기준으로 작성되었습니다.*
*대상 파일: dni_school_report_config.py, dni_school_report_generator.py, dni_school_report_merge.py*

# 장비별·가상/구성별 파일 생성 기반 환경

## 개요
통합 가상자산(VA)·구성정보(CFG) 엑셀을 **대상 학교 리스트(CNE_LIST.xlsx)** 로 필터한 뒤, **장비별** × **가상자산/구성정보** 조합으로 CSV를 생성하는 파이프라인 기반을 정리한 문서입니다.

## 로드 검증 (필수)
- **717 = 학교 수. 장비 행은 그보다 훨씬 많아야 함**. 이보다 훨씬 적게 나오면 시트명/헤더가 다른 형태로 되어 있는 것이므로, 데이터를 잘못 찾은 것으로 간주합니다.
- **기대 기준**: 정상 719개 학교, 최소 717개. 유니크 학교 수 ≥ EXPECTED_MIN_SCHOOLS(717), 장비 시트 총 행 수 ≥ EXPECTED_MIN_EQUIPMENT_ROWS(2000). 로드 직후 장비 시트별 행 수를 검사하며, 한 시트라도 기준 미달이면 **실행을 중단**하고 오류 메시지와 함께 “어떤 시트/헤더로 읽으면 충분한 행이 나오는지” 탐지 결과를 출력합니다.
- **헤더 자동 탐지**: `load_excel`에서 장비 시트는 헤더 1~4행을 순서대로 시도해, **관리번호** 컬럼이 있고 데이터 행 수가 가장 많은 조합을 사용합니다. (다른 형태로 되어 있어도 가능한 한 많이 읽도록 함.)
- 검증만 실행: `python -m src.load_validation 경로/가상자산.xlsx 경로/구성정보.xlsx` (옵션: `--min-schools=717 --min-rows=2000`).

## 정의 (단일 소스)

| 구분 | 정의 위치 | 내용 |
|------|-----------|------|
| 장비 종류 | `src/sheet_defs.py` | `VA_DATA_SHEETS_EQUIPMENT` = (PoE, AP, 스위치, 보안장비) |
| 데이터 종류 | `src/export_config.py` | 가상자산, 구성정보 |
| 출력 파일명 | `src/export_config.py` | `df_{장비}_가상자산.csv`, `df_{장비}_구성정보.csv` |

### 가상자산 제목행(관리코드)
- **원칙**: 관리코드는 제목행에서 **유일(1개)** 이어야 함.
- **원본 오기**: 일부 원본에서 '관리코드'가 2개인 경우가 있음. 대부분 **학교코드를 적어야 할 열에 '관리코드'라고 잘못 적힌 경우**임. 이런 자료도 처리할 수 있도록, 2개일 때 값이 학교코드-장비 형식인 쪽을 관리번호로 사용함 (`src/sheet_defs.py` 해석·정규화).

## 데이터 흐름

1. **입력**
   - 가상자산: 통합 VA 엑셀 1개 (시트: 학교정보, PoE, AP, 스위치, 보안장비)
   - 구성정보: 통합 CFG 엑셀 1개 (시트: AP, PoE, 스위치, 보안장비)
   - 대상 학교: `output/CNE_LIST.xlsx` (학교코드·학교명)

2. **처리**
   - VA/CFG 로드 → 관리번호 prefix로 학교코드 추출 → 대상 학교코드만 필터

3. **출력** (`output/`)
   - `df_PoE_가상자산.csv`, `df_PoE_구성정보.csv`
   - `df_AP_가상자산.csv`, `df_AP_구성정보.csv`
   - `df_스위치_가상자산.csv`, `df_스위치_구성정보.csv`
   - `df_보안장비_가상자산.csv`, `df_보안장비_구성정보.csv`
   - `통합_export_로그.txt`, `통합_export_요약.json`, `719중_장비별_데이터없는_학교.csv`

## 설정

- **config/paths.example.json** (또는 paths.local.json)
  - `raw_data_root`: 원본 데이터 루트. 아래 구성/자산/충남 폴더의 부모 경로.
    - 프로젝트 안: `./raw_data` → `CNE_DNI/raw_data`
    - 프로젝트 밖(Projects 바로 아래): `../raw_data` → `Projects/raw_data`
  - `va_file`: 가상자산 엑셀 경로 (비면 코드 기본값)
  - `cfg_file`: 구성정보 엑셀 경로 (비면 코드 기본값)
  - `target_school_list`: 대상 학교 리스트 (기본: `./output/CNE_LIST.xlsx`)
  - `output_root`: 출력 디렉터리 (기본: `./output`)

## raw_data 폴더 구조 (검증용)

`raw_data_root` 아래에는 다음 폴더를 둘 수 있습니다. **통합 파이프라인 결과**와 함께 검증할 때 사용합니다.

| 폴더 | 설명 |
|------|------|
| **구성** | 구성정보 통합/원본. 지역별로 구분된 파일과 장비별 통합 파일이 섞여 있을 수 있음. |
| **자산** | 가상자산 통합/원본. 마찬가지로 지역별·장비별 혼재 가능. |
| **충남** | 학교별 폴더(예: `11_예산/광시중학교/`) — 통합 파일에 없는 학교 자료 확인용. |

- **검증 흐름**: `integrate_export`로 만든 장비별 CSV(또는 통합 VA/CFG)와, **구성**·**자산** 폴더 안의 엑셀을 비교해 학교 수·행 수·유니크 학교코드가 맞는지 확인하면 됩니다.
- 스캔/비교 스크립트: `python -m src.verify_raw_data` (raw_data가 준비된 후 실행).
- **전체 병합·통합**: `python -m src.merge_raw_sources` — 구성/자산/충남을 모두 로드해 병합(충남 기준 + 구성·자산에서 없는 행 추가) 후 장비별 CSV·데이터 없는 학교 리스트·보고서 생성. 충남 파일이 5천 개 이상이면 **30~50분** 정도 걸릴 수 있음.

## 데이터 전혀 없는 학교 → 학교별 폴더에 자료 있음

통합 VA/CFG 파일에는 없지만 **학교별 폴더**에만 자료가 있는 경우가 있습니다(클라우드 다운로드/열기 이슈 등).  
이런 학교는 **데이터_전혀_없는_학교.csv**에 포함되므로, 아래 위치에서 직접 확인하면 됩니다.

**학교별 자료 경로 패턴** (예: 예산 광시중학교 N108271011MS):

```
.../Lee_20260202/충남/{지역번호}_{지역명}/{학교폴더명}/
  {학교코드}_{학교명}_AP_일괄업로드용_가상자산DB.xlsx
  {학교코드}_{학교명}_AP_일괄업로드용_구성정보DB.xlsx
  {학교코드}_{학교명}_PoE_일괄업로드용_가상자산DB.xlsx
  {학교코드}_{학교명}_PoE_일괄업로드용_구성정보DB.xlsx
  {학교코드}_{학교명}_스위치_일괄업로드용_가상자산DB.xlsx
  {학교코드}_{학교명}_스위치_일괄업로드용_구성정보DB.xlsx
  {학교코드}_{학교명}_보안장비_일괄업로드용_가상자산DB.xlsx
  {학교코드}_{학교명}_보안장비_일괄업로드용_구성정보DB.xlsx
```

- **실제 예**: `충남/11_예산/광시중학교/N108271011MS_광시중학교_AP_일괄업로드용_가상자산DB.xlsx` 등 8개 파일.
- **데이터_전혀_없는_학교.csv**의 `지역` 컬럼으로 지역(예산, 보령 등)을 보고, 해당 지역 폴더 아래 **학교폴더명**(학교명 기준)에서 위 패턴으로 파일을 찾으면 됩니다.

## 확장 시 고려사항

- **지역별·장비별 원본**(예: 보령 `보령_AP_일괄업로드용_가상자산DB.xlsx`)을 쓰는 경우:  
  `va_file`/`cfg_file`을 해당 통합 파일로 두거나, 추후 **다중 소스 로드 → 병합 후 동일 파이프라인**으로 확장 가능.
- **학교별 폴더**(예: `11_예산/광시중학교/` 내 8개 파일):  
  통합 파일에 없는 학교는 위 경로 패턴으로 수동 확인. 추후 **학교별 폴더 스캔 → 통합 VA/CFG에 병합** 스크립트로 반영 가능.
